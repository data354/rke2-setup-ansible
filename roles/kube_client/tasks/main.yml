---
- name: Setting up kube config
  become: true
  block:
    - name: Download kubeconfig file
      delegate_to: control_plane[0]
      ansible.builtin.slurp:
        src: /etc/rancher/rke2/rke2.yaml
      register: kubeconfig

    - name: Create kube config Folder
      ansible.builtin.file:
        state: directory
        mode: "700"
        path: "{{ kube_config_directory }}"

    - name: Create local kubeconfig file
      ansible.builtin.file:
        content: "{{ kubeconfig | b64decode | from_yaml }}"
        path: "{{ kube_config_directory }}/config"
        mode: "700"
        state: present

    - name: Replace api server ip by loadbalancer ip
      ansible.builtin.replace:
        path: "{{ kube_config_directory }}/config"
        regexp: '127\.0\.0\.1'
        replace: '{{ loadbalancer_addresses[0] }}'

- name: Install Kubectl
  become: true
  ansible.builtin.apt:
    name: kubectl
    state: present

- name: Install Helm
  become: true
  block:
    - name: Download helm script
      ansible.builtin.get_url:
        owner: root
        mode: 700
        dest: /home/k8s/get_helm.sh
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3

    - name: Run helm script
      ansible.builtin.command:
        cmd: bash get_helm.sh
        chdir: /home/k8s/
      register: my_output
      changed_when: my_output.rc != 0
